<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X1 Punks</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--tg-theme-bg-color, #0d1117);
            color: var(--tg-theme-text-color, #e6edf3);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 12px;
        }

        /* Wallet Bar */
        .wallet-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .wallet-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .wallet-address {
            font-size: 0.8rem;
            color: #8b949e;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .wallet-balance {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .deposit-btn {
            background: linear-gradient(135deg, #238636, #2ea043);
            border: none;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            margin-left: 12px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 10px 0 16px;
            border-bottom: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 2.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logo-x { color: #00d4ff; text-shadow: 0 0 15px #00d4ff; }
        .logo-text { color: var(--tg-theme-text-color, #e6edf3); }

        /* Hero */
        .hero {
            text-align: center;
            padding: 20px 0;
        }

        .hero h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00d4ff 0%, #00a8cc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p { font-size: 1rem; color: #8b949e; margin-bottom: 6px; }

        /* Stats */
        .stats {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            background: rgba(0, 212, 255, 0.05);
            padding: 14px 20px;
            border-radius: 10px;
            border: 1px solid #30363d;
            flex: 1;
            min-width: 80px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            color: #8b949e;
            margin-top: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Inscribe Section */
        .mint-section { margin: 20px 0; text-align: center; }
        .mint-section h2 {
            font-size: 1.6rem;
            color: #00d4ff;
            margin-bottom: 16px;
        }

        /* Info boxes */
        .mint-info {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .info-box {
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 12px 16px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .info-box h3 { color: #8b949e; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .info-box p { color: var(--tg-theme-text-color, #e6edf3); font-size: 1rem; font-weight: bold; }

        .info-box.max-mint-box {
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            background: rgba(255, 215, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .info-box.max-mint-box:active {
            transform: scale(0.95);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
        }
        .info-box.max-mint-box h3 { color: #ffd700; }
        .info-box.max-mint-box p { color: #ffd700; }
        .info-box.max-mint-box .party-hint {
            font-size: 0.6rem;
            color: #ffd700;
            opacity: 0.7;
            margin-top: 2px;
            font-style: italic;
            letter-spacing: 0.5px;
        }

        /* Quantity selector */
        .quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid #00d4ff;
            background: transparent;
            color: #00d4ff;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .qty-btn:active { background: rgba(0, 212, 255, 0.2); }

        .qty-input {
            width: 70px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--tg-theme-text-color, #e6edf3);
            background: rgba(22, 27, 34, 0.8);
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 8px;
            font-family: inherit;
        }

        /* Inscribe Button */
        .mint-btn {
            width: 100%;
            background: var(--tg-theme-button-color, linear-gradient(135deg, #00d4ff 0%, #0099cc 100%));
            border: none;
            color: var(--tg-theme-button-text-color, #0d1117);
            padding: 16px;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mint-btn:active { opacity: 0.8; }
        .mint-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Status */
        .status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status.show { display: block; }
        .status.success { background: rgba(35, 134, 54, 0.2); border: 1px solid #238636; color: #3fb950; }
        .status.error { background: rgba(248, 81, 73, 0.2); border: 1px solid #f85149; color: #f85149; }
        .status.loading { background: rgba(0, 212, 255, 0.1); border: 1px solid #00d4ff; color: #00d4ff; }

        /* Tabs */
        .tab-bar {
            display: flex;
            gap: 0;
            margin: 20px 0 16px;
            border-bottom: 2px solid #30363d;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: #8b949e;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-family: inherit;
        }

        .tab-btn.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Punk Grid */
        .punk-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 6px;
            padding: 16px;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid #30363d;
            border-radius: 12px;
        }

        .punk-showcase.empty {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }

        .empty-message {
            text-align: center;
            color: #8b949e;
            font-size: 1rem;
            line-height: 1.8;
        }

        .punk-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
        }

        .punk-item.owned { border: 2px solid #ffd700; box-shadow: 0 0 8px rgba(255, 215, 0, 0.3); }

        .punk-img {
            width: 100%;
            aspect-ratio: 1;
            image-rendering: pixelated;
            cursor: pointer;
            display: block;
        }

        .owned-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ffd700;
            color: #000;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* Inscription Modal */
        .inscription-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .inscription-modal.show { display: flex; }

        .modal-content {
            background: var(--tg-theme-secondary-bg-color, #161b22);
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: #8b949e;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-punk-image {
            width: 160px;
            height: 160px;
            image-rendering: pixelated;
            border-radius: 12px;
            border: 3px solid #00d4ff;
            display: block;
            margin: 0 auto 16px;
        }

        .modal-title {
            text-align: center;
            font-size: 1.3rem;
            color: #00d4ff;
            margin-bottom: 12px;
        }

        .attribute-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .attribute-box {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .attribute-label { color: #8b949e; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; }
        .attribute-value { color: var(--tg-theme-text-color, #e6edf3); font-weight: bold; margin-top: 2px; font-size: 0.85rem; }

        .modal-image-size { text-align: center; color: #8b949e; margin-top: 8px; font-size: 0.8rem; }

        .on-chain-badge {
            text-align: center;
            margin-top: 8px;
            padding: 8px;
            background: rgba(35, 134, 54, 0.2);
            border: 1px solid #238636;
            border-radius: 8px;
            color: #3fb950;
            font-weight: bold;
            font-size: 0.85rem;
        }

        /* Inscribing Loading Screen */
        .inscribing-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .inscribing-overlay.show { display: flex; }

        .inscribing-content { text-align: center; padding: 20px; }

        .inscribing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #30363d;
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .inscribing-text {
            font-size: 1.4rem;
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .inscribing-subtext { color: #8b949e; font-size: 0.9rem; }

        /* Celebration Overlay */
        .mint-celebration {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            z-index: 3001;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
        }

        .mint-celebration.show { display: flex; }

        .celebration-punk {
            width: 160px;
            height: 160px;
            image-rendering: pixelated;
            border-radius: 12px;
            border: 5px solid #00d4ff;
            animation: explode 0.5s ease-out;
        }

        .celebration-text {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 16px;
            color: #00d4ff;
            text-shadow: 0 0 20px #00d4ff;
        }

        .celebration-id { font-size: 1.2rem; color: var(--tg-theme-text-color, #e6edf3); margin-top: 8px; }
        .celebration-counter { font-size: 0.9rem; color: #8b949e; margin-top: 8px; }

        /* Rarity celebration colors */
        .celebration-legendary .celebration-text { color: #ffd700; text-shadow: 0 0 30px #ffd700; }
        .celebration-legendary .celebration-punk { border-color: #ffd700; box-shadow: 0 0 40px #ffd700; }
        .celebration-epic .celebration-text { color: #a855f7; text-shadow: 0 0 30px #a855f7; }
        .celebration-epic .celebration-punk { border-color: #a855f7; box-shadow: 0 0 40px #a855f7; }
        .celebration-rare .celebration-text { color: #22c55e; text-shadow: 0 0 30px #22c55e; }
        .celebration-rare .celebration-punk { border-color: #22c55e; box-shadow: 0 0 40px #22c55e; }
        .celebration-common .celebration-text { color: #00d4ff; text-shadow: 0 0 30px #00d4ff; }
        .celebration-common .celebration-punk { border-color: #00d4ff; box-shadow: 0 0 40px #00d4ff; }

        .skip-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* MAX INSCRIBE (10) Special */
        .mint-celebration.max-mint {
            background: linear-gradient(135deg,
                rgba(255, 0, 255, 0.3),
                rgba(0, 255, 255, 0.3),
                rgba(255, 255, 0, 0.3));
            background-size: 400% 400%;
            animation: maxMintBg 3s ease infinite;
        }
        @keyframes maxMintBg {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .mint-celebration.max-mint .celebration-text {
            font-size: 2.5rem;
            color: #ffd700;
            animation: maxMintText 0.5s ease infinite alternate;
        }
        @keyframes maxMintText {
            0% { transform: scale(1); text-shadow: 0 0 20px #ffd700; }
            100% { transform: scale(1.1); text-shadow: 0 0 40px #ff6600; }
        }

        .mint-celebration.max-mint .celebration-punk {
            border-color: #ffd700;
            animation: maxMintPunk 0.3s ease infinite alternate;
        }
        @keyframes maxMintPunk {
            0% { box-shadow: 0 0 30px #ffd700; }
            100% { box-shadow: 0 0 60px #ff6600, 0 0 100px #ffd700; }
        }

        .mint-celebration.max-mint .celebration-id { color: #ffd700; }
        .mint-celebration.max-mint .celebration-counter { color: #ffd700; font-size: 1.1rem; font-weight: bold; }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: confettiFall 2s ease-out infinite;
            display: none;
        }
        .mint-celebration.max-mint .confetti { display: block; }
        @keyframes confettiFall {
            0% { top: -10px; opacity: 1; transform: rotate(0deg); }
            100% { top: 100%; opacity: 0; transform: rotate(720deg); }
        }

        /* Max Inscribe Intro Screen */
        .max-mint-intro {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0a30 0%, #0a0015 100%);
            z-index: 3003;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        .max-mint-intro.show { display: flex; }

        .max-mint-intro h1 {
            font-size: 3.5rem;
            background: linear-gradient(90deg, #ffd700, #ff6600, #ff00ff, #ffd700);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientText 2s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes gradientText {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }

        .max-mint-intro p { font-size: 1.2rem; color: #e6edf3; margin-bottom: 8px; }

        .max-mint-intro .count-display {
            font-size: 6rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 40px #ffd700, 0 0 80px #ff6600;
            margin: 16px 0;
            animation: countPulse 0.5s ease infinite alternate;
        }
        @keyframes countPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .party-btn {
            padding: 16px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd700, #ff6600);
            color: #000;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
            animation: partyBtnPulse 0.5s ease infinite alternate;
        }
        @keyframes partyBtnPulse {
            0% { transform: scale(1); box-shadow: 0 0 20px #ffd700; }
            100% { transform: scale(1.05); box-shadow: 0 0 40px #ff6600; }
        }

        /* Party Screen */
        .party-screen {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0015 0%, #1a0a30 50%, #0a0015 100%);
            z-index: 3002;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            overflow-y: auto;
        }
        .party-screen.show { display: flex; }

        .party-header { text-align: center; margin-bottom: 16px; }
        .party-header h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientText 2s linear infinite;
        }

        .party-counter { font-size: 1.5rem; color: #ffd700; text-shadow: 0 0 15px #ffd700; margin-top: 8px; }

        .party-boom-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            min-height: 320px;
        }

        .party-boom-punk {
            width: 240px; height: 240px;
            border-radius: 16px;
            border: 5px solid #ffd700;
            box-shadow: 0 0 40px #ffd700, 0 0 80px #ff6600, 0 0 120px rgba(255, 102, 0, 0.3);
            image-rendering: pixelated;
            animation: boomPunkAppear 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes boomPunkAppear {
            0% { opacity: 0; transform: scale(0) rotate(-30deg); }
            50% { opacity: 1; transform: scale(1.4) rotate(10deg); }
            70% { transform: scale(0.9) rotate(-3deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        .party-boom-text {
            font-size: 2.8rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700, 0 0 40px #ff6600;
            margin-top: 12px;
            animation: boomTextPulse 0.4s ease infinite alternate;
        }
        @keyframes boomTextPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.15); }
        }

        .party-boom-id { font-size: 1.5rem; color: #fff; text-shadow: 0 0 15px #00d4ff; margin-top: 6px; font-weight: bold; }

        .party-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-width: 500px;
            padding: 16px;
            padding-bottom: 80px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 2px solid #30363d;
            min-height: 100px;
            margin-bottom: 70px;
        }

        .party-punk {
            width: 100px; height: 100px;
            border-radius: 10px;
            border: 3px solid transparent;
            image-rendering: pixelated;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .party-punk:hover {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .party-punk.new-arrival {
            animation: partyPunkAppear 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: scale(0) rotate(-180deg);
        }
        @keyframes partyPunkAppear {
            0% { opacity: 0; transform: scale(0) rotate(-180deg); }
            40% { opacity: 1; transform: scale(1.4) rotate(15deg); }
            65% { transform: scale(0.85) rotate(-5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        .party-punk-container { display: flex; flex-direction: column; align-items: center; }
        .party-punk-id { font-size: 0.9rem; color: #fff; margin-top: 4px; text-shadow: 0 0 10px #00d4ff; font-weight: bold; }

        .party-done-btn {
            position: fixed;
            bottom: 20px;
            left: 50%; transform: translateX(-50%);
            padding: 12px 32px;
            font-size: 1rem;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            border: none;
            font-weight: bold;
            z-index: 3010;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
        }

        @keyframes explode {
            0% { transform: scale(0); box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); box-shadow: 0 0 80px 40px rgba(0, 212, 255, 0); }
        }

        /* Deposit Modal */
        .deposit-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .deposit-modal.show { display: flex; }

        .deposit-content {
            background: var(--tg-theme-secondary-bg-color, #161b22);
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .deposit-title {
            font-size: 1.3rem;
            color: #00d4ff;
            margin-bottom: 16px;
        }

        .deposit-address-box {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.85rem;
            color: #e6edf3;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .deposit-copy-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border: none;
            color: #000;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 8px;
        }

        .deposit-export-btn {
            background: none;
            border: 1px solid #f0883e;
            color: #f0883e;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .deposit-export-btn:active {
            background: rgba(240, 136, 62, 0.1);
        }

        .deposit-close-btn {
            background: none;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
        }

        .deposit-note {
            color: #8b949e;
            font-size: 0.8rem;
            margin-top: 12px;
        }

        /* Wallet Action Buttons */
        .wallet-actions {
            display: flex;
            gap: 8px;
            margin-left: 8px;
        }

        .wallet-action-btn {
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .send-xnt-btn { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #000; }
        .send-punk-btn { background: linear-gradient(135deg, #a855f7, #7c3aed); }

        /* Send Modal */
        .send-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .send-modal.show { display: flex; }

        .send-content {
            background: var(--tg-theme-secondary-bg-color, #161b22);
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .send-title {
            font-size: 1.3rem;
            color: #00d4ff;
            margin-bottom: 16px;
            text-align: center;
        }

        .send-label {
            color: #8b949e;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            margin-top: 14px;
        }

        .send-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            color: var(--tg-theme-text-color, #e6edf3);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
        }
        .send-input:focus { border-color: #00d4ff; }
        .send-input::placeholder { color: #484f58; }

        .send-amount-row {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .send-amount-row .send-input { flex: 1; }

        .max-btn {
            background: linear-gradient(135deg, #ffd700, #ff6600);
            border: none;
            color: #000;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .max-btn:active { opacity: 0.8; }

        .send-balance-hint {
            font-size: 0.8rem;
            color: #8b949e;
            margin-top: 4px;
        }

        .send-submit-btn {
            width: 100%;
            margin-top: 20px;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .send-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .send-xnt-submit { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #000; }
        .send-punk-submit { background: linear-gradient(135deg, #a855f7, #7c3aed); color: #fff; }

        .send-cancel-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background: none;
            border: 1px solid #30363d;
            color: #8b949e;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: inherit;
        }

        /* Punk selector grid for sending */
        .punk-select-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px solid #30363d;
        }

        .punk-select-item {
            width: 56px;
            height: 56px;
            border-radius: 6px;
            border: 2px solid #30363d;
            image-rendering: pixelated;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .punk-select-item.selected {
            border-color: #a855f7;
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.5);
        }

        .punk-select-item:active { opacity: 0.7; }

        .send-selected-count {
            font-size: 0.85rem;
            color: #a855f7;
            margin-top: 6px;
            font-weight: 600;
        }

        .send-status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            display: none;
        }
        .send-status.show { display: block; }
        .send-status.success { background: rgba(35, 134, 54, 0.2); border: 1px solid #238636; color: #3fb950; }
        .send-status.error { background: rgba(248, 81, 73, 0.2); border: 1px solid #f85149; color: #f85149; }
        .send-status.loading { background: rgba(0, 212, 255, 0.1); border: 1px solid #00d4ff; color: #00d4ff; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Wallet Bar -->
        <div class="wallet-bar" id="walletBar" style="display: none;">
            <div class="wallet-info">
                <div class="wallet-address" id="walletAddress" onclick="showDepositModal()">Loading...</div>
                <div class="wallet-balance" id="walletBalance">0 XNT</div>
            </div>
            <div class="wallet-actions">
                <button class="wallet-action-btn deposit-btn" onclick="showDepositModal()">Deposit</button>
                <button class="wallet-action-btn send-xnt-btn" onclick="showSendXntModal()">Send</button>
                <button class="wallet-action-btn send-punk-btn" onclick="showSendPunkModal()">Send Punk</button>
            </div>
        </div>

        <header>
            <div class="logo">
                <span class="logo-x">X1</span>
                <span class="logo-text">PUNKS</span>
            </div>
        </header>

        <section class="hero">
            <h1>INSCRIBE YOUR X1 PUNK</h1>
            <p>10,000 unique pixel punks <strong>fully inscribed on-chain</strong></p>
            <p style="color: #00d4ff; font-size: 0.85rem; margin-top: 6px;">Image + Metadata stored 100% on X1 Blockchain</p>
        </section>

        <section class="mint-section">
            <h2>INSCRIBE NOW</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalMinted">0</div>
                    <div class="stat-label">Inscribed</div>
                </div>
                <div class="stat">
                    <div class="stat-value">10,000</div>
                    <div class="stat-label">Supply</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="mintPrice">3.05 XNT</div>
                    <div class="stat-label">Price (incl. fees)</div>
                </div>
            </div>

            <div class="mint-info">
                <div class="info-box">
                    <h3>Network</h3>
                    <p>X1 Testnet</p>
                </div>
                <div class="info-box max-mint-box" id="maxMintBox">
                    <h3>Max Per Inscribe</h3>
                    <p>10</p>
                    <div class="party-hint">üéâ Party Time</div>
                </div>
                <div class="info-box">
                    <h3>Total Cost</h3>
                    <p id="totalCost">3.05 XNT</p>
                </div>
            </div>

            <div class="quantity-selector">
                <button class="qty-btn" id="qtyMinus">-</button>
                <input type="number" class="qty-input" id="qtyInput" value="1" min="1" max="10">
                <button class="qty-btn" id="qtyPlus">+</button>
            </div>

            <button class="mint-btn" id="mintBtn" disabled>Loading...</button>

            <div class="status" id="statusMessage"></div>
        </section>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="recent">Recently Inscribed</button>
            <button class="tab-btn" data-tab="collection">My Collection</button>
        </div>

        <div class="tab-content active" id="tab-recent">
            <div class="punk-showcase" id="punkShowcase">
                <div class="empty-message">Loading...</div>
            </div>
        </div>

        <div class="tab-content" id="tab-collection">
            <div class="punk-showcase" id="myCollection">
                <div class="empty-message">Inscribe your first punk!</div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="deposit-modal" id="depositModal">
        <div class="deposit-content">
            <div class="deposit-title">Deposit XNT</div>
            <p style="color: #8b949e; margin-bottom: 12px; font-size: 0.9rem;">Send XNT to this address to fund inscriptions:</p>
            <div class="deposit-address-box" id="depositAddress" onclick="copyAddress()">Loading...</div>
            <button class="deposit-copy-btn" id="copyAddrBtn" onclick="copyAddress()">Copy Address</button>
            <button class="deposit-export-btn" id="exportKeyBtn" onclick="exportPrivateKey()">üîë Export Private Key</button>
            <div id="privateKeyBox" style="display:none; margin-top:8px;">
                <div style="color:#f85149; font-size:0.75rem; margin-bottom:6px; font-weight:bold;">‚ö†Ô∏è NEVER share your private key. Anyone with it can steal your funds.</div>
                <div class="deposit-address-box" id="privateKeyDisplay" style="font-size:0.55rem; word-break:break-all; color:#f0883e; border-color:#f0883e; cursor:pointer;" onclick="copyPrivateKey()">Loading...</div>
                <button class="deposit-copy-btn" id="copyKeyBtn" onclick="copyPrivateKey()" style="background:linear-gradient(135deg,#f0883e,#d47520); margin-top:6px;">Copy Private Key</button>
            </div>
            <button class="deposit-close-btn" onclick="closeDepositModal()">Close</button>
            <div class="deposit-note">Each punk costs 3.05 XNT (3 XNT + 0.05 inscription fee). Network: X1 Testnet</div>
        </div>
    </div>

    <!-- Send XNT Modal -->
    <div class="send-modal" id="sendXntModal">
        <div class="send-content">
            <div class="send-title">Send XNT</div>
            <div class="send-label">Recipient Address</div>
            <input class="send-input" id="sendXntRecipient" type="text" placeholder="Paste Solana / X1 address...">
            <div class="send-label">Amount (XNT)</div>
            <div class="send-amount-row">
                <input class="send-input" id="sendXntAmount" type="number" step="0.0001" min="0" placeholder="0.00">
                <button class="max-btn" id="sendXntMaxBtn" onclick="sendXntMax()">MAX</button>
            </div>
            <div class="send-balance-hint" id="sendXntBalanceHint">Available: 0 XNT</div>
            <div class="send-status" id="sendXntStatus"></div>
            <button class="send-submit-btn send-xnt-submit" id="sendXntSubmit" onclick="handleSendXnt()">Send XNT</button>
            <button class="send-cancel-btn" onclick="closeSendXntModal()">Cancel</button>
        </div>
    </div>

    <!-- Send Punk Modal -->
    <div class="send-modal" id="sendPunkModal">
        <div class="send-content">
            <div class="send-title">Send Punks</div>
            <div class="send-label">Recipient Address</div>
            <input class="send-input" id="sendPunkRecipient" type="text" placeholder="Paste Solana / X1 address...">
            <div class="send-label">Select Punks to Send</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                <div class="send-selected-count" id="sendPunkCount">0 selected</div>
                <button class="max-btn" onclick="sendPunkMax()">MAX (Select All)</button>
            </div>
            <div class="punk-select-grid" id="sendPunkGrid">
                <div style="color: #8b949e; padding: 20px; text-align: center; width: 100%;">Loading your punks...</div>
            </div>
            <div class="send-status" id="sendPunkStatus"></div>
            <button class="send-submit-btn send-punk-submit" id="sendPunkSubmit" onclick="handleSendPunk()">Send Punks</button>
            <button class="send-cancel-btn" onclick="closeSendPunkModal()">Cancel</button>
        </div>
    </div>

    <!-- Inscription Modal -->
    <div class="inscription-modal" id="inscriptionModal">
        <div class="modal-content" style="position: relative;">
            <button class="modal-close" id="modalClose">&times;</button>
            <img class="modal-punk-image" id="modalPunkImage" src="" alt="Punk">
            <div class="modal-title" id="modalTitle">X1 Punk #0</div>
            <div class="on-chain-badge" id="onChainBadge" style="display: none;"></div>
            <div class="modal-image-size" id="modalImageSize"></div>
            <div class="attribute-grid" id="modalAttributes"></div>
        </div>
    </div>

    <!-- Inscribing Loading Screen -->
    <div class="inscribing-overlay" id="inscribingOverlay">
        <div class="inscribing-content">
            <div class="inscribing-spinner"></div>
            <div class="inscribing-text">Inscribing on-chain...</div>
            <div class="inscribing-subtext">Creating NFT + Writing image & metadata to blockchain</div>
        </div>
    </div>

    <!-- Max Inscribe Intro Screen -->
    <div class="max-mint-intro" id="maxMintIntro">
        <h1>MAX INSCRIBE!</h1>
        <p>You're inscribing</p>
        <div class="count-display">10</div>
        <p>X1 Punks on-chain!</p>
        <button class="party-btn" id="partyBtn">LET'S PARTY!</button>
    </div>

    <!-- Max Inscribe Party Screen -->
    <div class="party-screen" id="partyScreen">
        <div class="party-header">
            <h1>YOUR X1 PUNKS</h1>
            <div class="party-counter" id="partyCounter">0 / 10</div>
        </div>
        <div class="party-boom-area" id="partyBoomArea">
            <img class="party-boom-punk" id="partyBoomPunk" src="" alt="Punk">
            <div class="party-boom-text">BOOM!</div>
            <div class="party-boom-id" id="partyBoomId">X1 Punk #0</div>
        </div>
        <div class="party-grid" id="partyGrid"></div>
        <button class="skip-btn party-done-btn" id="partyDoneBtn" style="display: none;">View My Collection</button>
    </div>

    <!-- Celebration Overlay -->
    <div class="mint-celebration" id="mintCelebration">
        <div class="confetti" style="left: 10%; background: #ff00ff; animation-delay: 0s;"></div>
        <div class="confetti" style="left: 20%; background: #00ffff; animation-delay: 0.2s;"></div>
        <div class="confetti" style="left: 30%; background: #ffff00; animation-delay: 0.4s;"></div>
        <div class="confetti" style="left: 40%; background: #ff6600; animation-delay: 0.1s;"></div>
        <div class="confetti" style="left: 50%; background: #ff00ff; animation-delay: 0.3s;"></div>
        <div class="confetti" style="left: 60%; background: #00ffff; animation-delay: 0.5s;"></div>
        <div class="confetti" style="left: 70%; background: #ffff00; animation-delay: 0.15s;"></div>
        <div class="confetti" style="left: 80%; background: #ff6600; animation-delay: 0.35s;"></div>
        <div class="confetti" style="left: 90%; background: #ff00ff; animation-delay: 0.25s;"></div>
        <img class="celebration-punk" id="celebrationPunk" src="" alt="Punk">
        <div class="celebration-text" id="celebrationText">BOOM!</div>
        <div class="celebration-id" id="celebrationId">X1 Punk #0</div>
        <div class="celebration-counter" id="celebrationCounter">1 of 1</div>
        <button class="skip-btn" id="skipBtn">Skip All</button>
    </div>

    <script>
        // ---- Telegram Mini App Init ----
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const MINT_PRICE = 3;        // XNT per punk
        const INSCRIPTION_FEE = 0.05; // on-chain inscription fee per punk
        const TOTAL_PER_PUNK = MINT_PRICE + INSCRIPTION_FEE; // 3.05 XNT
        const MAX_PER_MINT = 10;

        // Safe JSON parse ‚Äî handles tunnel errors returning HTML instead of JSON
        async function safeJson(response) {
            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                throw new Error('Server connection lost. Please try again.');
            }
        }

        // State
        let currentUser = null;
        let quantity = 1;

        // DOM
        const walletBar = document.getElementById('walletBar');
        const walletAddress = document.getElementById('walletAddress');
        const walletBalance = document.getElementById('walletBalance');
        const mintBtn = document.getElementById('mintBtn');
        const qtyInput = document.getElementById('qtyInput');
        const totalCost = document.getElementById('totalCost');
        const statusMessage = document.getElementById('statusMessage');
        const punkShowcase = document.getElementById('punkShowcase');
        const myCollection = document.getElementById('myCollection');
        const inscriptionModal = document.getElementById('inscriptionModal');
        const mintCelebration = document.getElementById('mintCelebration');
        const celebrationPunk = document.getElementById('celebrationPunk');
        const celebrationId = document.getElementById('celebrationId');
        const celebrationText = document.getElementById('celebrationText');
        const celebrationCounter = document.getElementById('celebrationCounter');
        const maxMintIntro = document.getElementById('maxMintIntro');
        const partyScreen = document.getElementById('partyScreen');
        const partyGrid = document.getElementById('partyGrid');
        const partyCounter = document.getElementById('partyCounter');
        const partyBoomArea = document.getElementById('partyBoomArea');
        const partyBoomPunk = document.getElementById('partyBoomPunk');
        const partyBoomId = document.getElementById('partyBoomId');
        const partyDoneBtn = document.getElementById('partyDoneBtn');

        let skipCelebration = false;
        let partyMintedNfts = [];

        // ---- Init ----
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            await initTelegramUser();
            await loadPunkShowcase();
        });

        // ---- Telegram Auth ----
        async function initTelegramUser() {
            try {
                mintBtn.textContent = 'Connecting...';
                const response = await fetch('/api/telegram-auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                const data = await safeJson(response);

                if (data.success && data.user) {
                    currentUser = data.user;
                    walletBar.style.display = 'flex';
                    const pk = currentUser.publicKey;
                    walletAddress.textContent = `${pk.slice(0, 6)}...${pk.slice(-4)}`;
                    walletBalance.textContent = `${currentUser.balance.toFixed(4)} XNT`;
                    document.getElementById('depositAddress').textContent = pk;
                    mintBtn.disabled = false;
                    mintBtn.textContent = `INSCRIBE ${quantity} PUNK${quantity > 1 ? 'S' : ''}`;
                    showStatus(`Welcome, ${currentUser.firstName || currentUser.username || 'Punk'}!`, 'success');
                    loadMyCollection();
                } else {
                    mintBtn.textContent = 'Auth Failed';
                    showStatus('Authentication failed', 'error');
                }
            } catch (err) {
                console.error('Auth error:', err);
                mintBtn.textContent = 'Connection Error';
                showStatus('Failed to connect: ' + err.message, 'error');
            }
        }

        // ---- Refresh Balance ----
        async function refreshBalance() {
            if (!currentUser) return;
            try {
                const resp = await fetch(`/api/wallet?telegramId=${currentUser.telegramId}`);
                const data = await safeJson(resp);
                if (data.balance !== undefined) {
                    currentUser.balance = data.balance;
                    walletBalance.textContent = `${data.balance.toFixed(4)} XNT`;
                }
            } catch (e) { /* silently fail */ }
        }

        // ---- Event Listeners ----
        function setupEventListeners() {
            mintBtn.addEventListener('click', handleInscribe);
            document.getElementById('qtyMinus').addEventListener('click', () => updateQuantity(-1));
            document.getElementById('qtyPlus').addEventListener('click', () => updateQuantity(1));
            qtyInput.addEventListener('input', handleQuantityInput);
            qtyInput.addEventListener('blur', validateQuantityInput);
            qtyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { validateQuantityInput(); qtyInput.blur(); }
            });

            // Max Mint Box ‚Äî click to set quantity to max
            document.getElementById('maxMintBox').addEventListener('click', () => {
                quantity = MAX_PER_MINT;
                qtyInput.value = quantity;
                totalCost.textContent = `${(TOTAL_PER_PUNK * quantity).toFixed(2)} XNT`;
                if (currentUser) {
                    mintBtn.textContent = `INSCRIBE ${quantity} PUNK${quantity > 1 ? 'S' : ''}`;
                }
                try { tg.HapticFeedback.impactOccurred('heavy'); } catch(e) {}
            });

            // Modal
            document.getElementById('modalClose').onclick = closeModal;
            inscriptionModal.onclick = (e) => { if (e.target === inscriptionModal) closeModal(); };

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
                    if (btn.dataset.tab === 'collection') loadMyCollection();
                });
            });

            // Celebrations
            document.getElementById('skipBtn').addEventListener('click', () => { skipCelebration = true; });
            document.getElementById('partyBtn').addEventListener('click', () => {
                maxMintIntro.classList.remove('show');
                showPartyScreen(partyMintedNfts);
            });
            partyDoneBtn.addEventListener('click', () => {
                partyScreen.classList.remove('show');
                partyDoneBtn.style.display = 'none';
            });
            mintCelebration.addEventListener('click', (e) => {
                if (e.target === mintCelebration) {
                    mintCelebration.classList.remove('show');
                    mintCelebration.className = 'mint-celebration';
                    maxMintIntro.classList.remove('show');
                }
            });

            // Telegram back button
            tg.BackButton.onClick(() => {
                if (document.getElementById('sendXntModal').classList.contains('show')) {
                    closeSendXntModal();
                } else if (document.getElementById('sendPunkModal').classList.contains('show')) {
                    closeSendPunkModal();
                } else if (inscriptionModal.classList.contains('show')) {
                    closeModal();
                } else if (partyScreen.classList.contains('show')) {
                    partyScreen.classList.remove('show');
                    partyDoneBtn.style.display = 'none';
                } else if (maxMintIntro.classList.contains('show')) {
                    maxMintIntro.classList.remove('show');
                } else if (mintCelebration.classList.contains('show')) {
                    mintCelebration.classList.remove('show');
                    mintCelebration.className = 'mint-celebration';
                } else if (document.getElementById('depositModal').classList.contains('show')) {
                    closeDepositModal();
                } else {
                    tg.close();
                }
            });
        }

        // ---- Quantity ----
        function updateQuantity(delta) {
            const newQty = quantity + delta;
            if (newQty >= 1 && newQty <= MAX_PER_MINT) {
                quantity = newQty;
                qtyInput.value = quantity;
                totalCost.textContent = `${(TOTAL_PER_PUNK * quantity).toFixed(2)} XNT`;
                if (currentUser) {
                    mintBtn.textContent = `INSCRIBE ${quantity} PUNK${quantity > 1 ? 'S' : ''}`;
                }
                try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
            }
        }

        function handleQuantityInput() {
            let val = parseInt(qtyInput.value) || 0;
            totalCost.textContent = `${(TOTAL_PER_PUNK * val).toFixed(2)} XNT`;
        }

        function validateQuantityInput() {
            let val = parseInt(qtyInput.value) || 1;
            val = Math.max(1, Math.min(MAX_PER_MINT, val));
            quantity = val;
            qtyInput.value = val;
            totalCost.textContent = `${(TOTAL_PER_PUNK * val).toFixed(2)} XNT`;
            if (currentUser) {
                mintBtn.textContent = `INSCRIBE ${quantity} PUNK${quantity > 1 ? 'S' : ''}`;
            }
        }

        // ---- Inscribe ----
        async function handleInscribe() {
            if (!currentUser) {
                showStatus('Not authenticated', 'error');
                return;
            }

            try {
                tg.HapticFeedback.impactOccurred('medium');
            } catch(e) {}

            mintBtn.disabled = true;
            const inscribingOverlay = document.getElementById('inscribingOverlay');
            inscribingOverlay.classList.add('show');
            showStatus('Inscribing on-chain...', 'loading');

            try {
                const response = await fetch('/api/inscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: currentUser.telegramId,
                        quantity: quantity,
                        initData: tg.initData
                    })
                });

                const result = await safeJson(response);
                inscribingOverlay.classList.remove('show');

                if (result.success) {
                    try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                    await showMintCelebration(result.minted);
                    const ids = result.minted.map(n => `#${n.id}`).join(', ');
                    const msg = result.partial
                        ? `Inscribed ${result.completed}/${result.requested}: ${ids}`
                        : `Inscribed ${quantity} punk${quantity > 1 ? 's' : ''}: ${ids}`;
                    showStatus(msg, 'success');
                } else {
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    showStatus(`Failed: ${result.error}`, 'error');
                }

                await refreshBalance();
                await loadPunkShowcase();
                await loadMyCollection();

            } catch (err) {
                console.error('Inscribe error:', err);
                try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                showStatus('Failed: ' + err.message, 'error');
            } finally {
                inscribingOverlay.classList.remove('show');
                mintBtn.disabled = false;
            }
        }

        // ---- Load Punk Showcase ----
        async function loadPunkShowcase() {
            try {
                const response = await fetch('/api/mints');
                const state = await safeJson(response);
                document.getElementById('totalMinted').textContent = state.mintedCount || 0;

                if (!state.mints || state.mints.length === 0) {
                    punkShowcase.classList.add('empty');
                    punkShowcase.innerHTML = '<div class="empty-message">No punks inscribed yet.<br>Be the first!</div>';
                    return;
                }

                punkShowcase.classList.remove('empty');
                punkShowcase.innerHTML = '';

                const mints = [...state.mints].reverse();
                mints.forEach(mint => {
                    const isOwned = currentUser && mint.owner === currentUser.publicKey;
                    const container = document.createElement('div');
                    container.className = 'punk-item' + (isOwned ? ' owned' : '');

                    const img = document.createElement('img');
                    img.src = `https://raw.githubusercontent.com/Execute007/x1punks-images/master/generated/punk_${mint.id}.png`;
                    img.className = 'punk-img';
                    img.alt = `X1 Punk #${mint.id}`;
                    img.dataset.punkId = mint.id;
                    img.onclick = () => showInscriptionDetails(mint.id);
                    img.onerror = function() { container.style.display = 'none'; };

                    container.appendChild(img);
                    if (isOwned) {
                        const badge = document.createElement('div');
                        badge.className = 'owned-badge';
                        badge.innerHTML = '&#10003;';
                        container.appendChild(badge);
                    }
                    punkShowcase.appendChild(container);
                });
            } catch (err) {
                punkShowcase.classList.add('empty');
                punkShowcase.innerHTML = '<div class="empty-message">Failed to load</div>';
            }
        }

        // ---- Load My Collection ----
        async function loadMyCollection() {
            if (!currentUser) return;
            try {
                const resp = await fetch(`/api/user-collection?telegramId=${currentUser.telegramId}`);
                const data = await safeJson(resp);

                if (!data.punks || data.punks.length === 0) {
                    myCollection.classList.add('empty');
                    myCollection.innerHTML = '<div class="empty-message">No punks yet. Inscribe your first!</div>';
                    return;
                }

                myCollection.classList.remove('empty');
                myCollection.innerHTML = '';
                data.punks.forEach(punk => {
                    const container = document.createElement('div');
                    container.className = 'punk-item owned';

                    const img = document.createElement('img');
                    img.src = punk.image;
                    img.className = 'punk-img';
                    img.alt = punk.name;
                    img.onclick = () => showInscriptionDetails(punk.punkId);
                    img.onerror = function() { container.style.display = 'none'; };

                    container.appendChild(img);
                    myCollection.appendChild(container);
                });
            } catch (e) {
                myCollection.innerHTML = '<div class="empty-message">Failed to load collection</div>';
            }
        }

        // ---- Deposit Modal ----
        function showDepositModal() {
            document.getElementById('depositModal').classList.add('show');
            tg.BackButton.show();
        }

        function closeDepositModal() {
            document.getElementById('depositModal').classList.remove('show');
            document.getElementById('privateKeyBox').style.display = 'none';
            document.getElementById('exportKeyBtn').textContent = 'üîë Export Private Key';
            updateBackButton();
        }

        function copyAddress() {
            if (!currentUser) return;
            const addr = currentUser.publicKey;
            const btn = document.getElementById('copyAddrBtn');
            navigator.clipboard.writeText(addr).then(() => {
                try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                btn.textContent = '‚úì Address Copied!';
                btn.style.background = 'linear-gradient(135deg, #2ea043, #238636)';
                setTimeout(() => { btn.textContent = 'Copy Address'; btn.style.background = ''; }, 2000);
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = addr;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                btn.textContent = '‚úì Address Copied!';
                btn.style.background = 'linear-gradient(135deg, #2ea043, #238636)';
                setTimeout(() => { btn.textContent = 'Copy Address'; btn.style.background = ''; }, 2000);
            });
        }

        async function exportPrivateKey() {
            if (!currentUser) return;
            const box = document.getElementById('privateKeyBox');
            const exportBtn = document.getElementById('exportKeyBtn');

            // Toggle visibility
            if (box.style.display !== 'none') {
                box.style.display = 'none';
                exportBtn.textContent = 'üîë Export Private Key';
                return;
            }

            try {
                exportBtn.textContent = 'Loading...';
                const resp = await fetch(`${API_BASE}/api/export-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: currentUser.telegramId,
                        initData: tg.initData
                    })
                });
                const data = await safeJson(resp);
                if (data.privateKey) {
                    document.getElementById('privateKeyDisplay').textContent = data.privateKey;
                    box.style.display = 'block';
                    exportBtn.textContent = 'üîë Hide Private Key';
                    try { tg.HapticFeedback.notificationOccurred('warning'); } catch(e) {}
                } else {
                    showStatus('Failed to export key: ' + (data.error || 'Unknown error'), 'error');
                    exportBtn.textContent = 'üîë Export Private Key';
                }
            } catch (err) {
                showStatus('Failed: ' + err.message, 'error');
                exportBtn.textContent = 'üîë Export Private Key';
            }
        }

        function copyPrivateKey() {
            const key = document.getElementById('privateKeyDisplay').textContent;
            if (!key || key === 'Loading...') return;
            const btn = document.getElementById('copyKeyBtn');
            navigator.clipboard.writeText(key).then(() => {
                try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                btn.textContent = '‚úì Key Copied!';
                btn.style.background = 'linear-gradient(135deg, #2ea043, #238636)';
                setTimeout(() => { btn.textContent = 'Copy Private Key'; btn.style.background = 'linear-gradient(135deg,#f0883e,#d47520)'; }, 2000);
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = key;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                btn.textContent = '‚úì Key Copied!';
                btn.style.background = 'linear-gradient(135deg, #2ea043, #238636)';
                setTimeout(() => { btn.textContent = 'Copy Private Key'; btn.style.background = 'linear-gradient(135deg,#f0883e,#d47520)'; }, 2000);
            });
        }

        // ---- Send XNT Modal ----
        function showSendXntModal() {
            document.getElementById('sendXntModal').classList.add('show');
            document.getElementById('sendXntRecipient').value = '';
            document.getElementById('sendXntAmount').value = '';
            document.getElementById('sendXntStatus').className = 'send-status';
            document.getElementById('sendXntBalanceHint').textContent = `Available: ${currentUser ? currentUser.balance.toFixed(4) : '0'} XNT`;
            document.getElementById('sendXntSubmit').disabled = false;
            tg.BackButton.show();
        }

        function closeSendXntModal() {
            document.getElementById('sendXntModal').classList.remove('show');
            updateBackButton();
        }

        function sendXntMax() {
            if (!currentUser) return;
            // Leave a tiny bit for tx fees
            const max = Math.max(0, currentUser.balance - 0.001);
            document.getElementById('sendXntAmount').value = max.toFixed(4);
            try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
        }

        async function handleSendXnt() {
            const recipient = document.getElementById('sendXntRecipient').value.trim();
            const amount = parseFloat(document.getElementById('sendXntAmount').value);
            const statusEl = document.getElementById('sendXntStatus');
            const submitBtn = document.getElementById('sendXntSubmit');

            if (!recipient) {
                statusEl.textContent = 'Enter recipient address';
                statusEl.className = 'send-status show error';
                return;
            }
            if (!amount || amount <= 0) {
                statusEl.textContent = 'Enter a valid amount';
                statusEl.className = 'send-status show error';
                return;
            }

            try { tg.HapticFeedback.impactOccurred('medium'); } catch(e) {}
            submitBtn.disabled = true;
            statusEl.textContent = 'Sending...';
            statusEl.className = 'send-status show loading';

            try {
                const resp = await fetch('/api/send-xnt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: currentUser.telegramId,
                        initData: tg.initData,
                        recipient,
                        amount
                    })
                });
                const result = await safeJson(resp);

                if (result.success) {
                    try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                    statusEl.textContent = `Sent ${amount} XNT! TX: ${result.signature.slice(0,12)}...`;
                    statusEl.className = 'send-status show success';
                    await refreshBalance();
                    document.getElementById('sendXntBalanceHint').textContent = `Available: ${currentUser.balance.toFixed(4)} XNT`;
                } else {
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    statusEl.textContent = result.error;
                    statusEl.className = 'send-status show error';
                }
            } catch (err) {
                try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                statusEl.textContent = 'Failed: ' + err.message;
                statusEl.className = 'send-status show error';
            } finally {
                submitBtn.disabled = false;
            }
        }

        // ---- Send Punk Modal ----
        let selectedPunkIds = [];

        function showSendPunkModal() {
            document.getElementById('sendPunkModal').classList.add('show');
            document.getElementById('sendPunkRecipient').value = '';
            document.getElementById('sendPunkStatus').className = 'send-status';
            document.getElementById('sendPunkSubmit').disabled = false;
            selectedPunkIds = [];
            updatePunkSelectCount();
            loadPunkSelectGrid();
            tg.BackButton.show();
        }

        function closeSendPunkModal() {
            document.getElementById('sendPunkModal').classList.remove('show');
            updateBackButton();
        }

        async function loadPunkSelectGrid() {
            const grid = document.getElementById('sendPunkGrid');
            if (!currentUser) {
                grid.innerHTML = '<div style="color: #8b949e; padding: 20px; text-align: center; width: 100%;">Not connected</div>';
                return;
            }

            try {
                const resp = await fetch(`/api/user-collection?telegramId=${currentUser.telegramId}`);
                const data = await safeJson(resp);

                if (!data.punks || data.punks.length === 0) {
                    grid.innerHTML = '<div style="color: #8b949e; padding: 20px; text-align: center; width: 100%;">No punks to send</div>';
                    return;
                }

                grid.innerHTML = '';
                data.punks.forEach(punk => {
                    const img = document.createElement('img');
                    img.src = punk.image;
                    img.className = 'punk-select-item';
                    img.alt = `#${punk.punkId}`;
                    img.title = `X1 Punk #${punk.punkId}`;
                    img.dataset.punkId = punk.punkId;
                    img.onclick = () => togglePunkSelect(punk.punkId, img);
                    grid.appendChild(img);
                });
            } catch (e) {
                grid.innerHTML = '<div style="color: #f85149; padding: 20px; text-align: center; width: 100%;">Failed to load</div>';
            }
        }

        function togglePunkSelect(punkId, imgEl) {
            const idx = selectedPunkIds.indexOf(punkId);
            if (idx >= 0) {
                selectedPunkIds.splice(idx, 1);
                imgEl.classList.remove('selected');
            } else {
                selectedPunkIds.push(punkId);
                imgEl.classList.add('selected');
            }
            try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
            updatePunkSelectCount();
        }

        function sendPunkMax() {
            const grid = document.getElementById('sendPunkGrid');
            const items = grid.querySelectorAll('.punk-select-item');
            selectedPunkIds = [];
            items.forEach(img => {
                const id = parseInt(img.dataset.punkId);
                if (!isNaN(id)) {
                    selectedPunkIds.push(id);
                    img.classList.add('selected');
                }
            });
            try { tg.HapticFeedback.impactOccurred('medium'); } catch(e) {}
            updatePunkSelectCount();
        }

        function updatePunkSelectCount() {
            document.getElementById('sendPunkCount').textContent = `${selectedPunkIds.length} selected`;
        }

        async function handleSendPunk() {
            const recipient = document.getElementById('sendPunkRecipient').value.trim();
            const statusEl = document.getElementById('sendPunkStatus');
            const submitBtn = document.getElementById('sendPunkSubmit');

            if (!recipient) {
                statusEl.textContent = 'Enter recipient address';
                statusEl.className = 'send-status show error';
                return;
            }
            if (selectedPunkIds.length === 0) {
                statusEl.textContent = 'Select at least one punk';
                statusEl.className = 'send-status show error';
                return;
            }

            try { tg.HapticFeedback.impactOccurred('medium'); } catch(e) {}
            submitBtn.disabled = true;
            statusEl.textContent = `Sending ${selectedPunkIds.length} punk${selectedPunkIds.length > 1 ? 's' : ''}...`;
            statusEl.className = 'send-status show loading';

            try {
                const resp = await fetch('/api/send-punk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: currentUser.telegramId,
                        initData: tg.initData,
                        recipient,
                        punkIds: selectedPunkIds
                    })
                });
                const result = await safeJson(resp);

                if (result.success) {
                    try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                    const count = result.transferred.length;
                    statusEl.textContent = `Sent ${count} punk${count > 1 ? 's' : ''}!${result.partial ? ` (${result.failed?.length || 0} failed)` : ''}`;
                    statusEl.className = 'send-status show success';
                    selectedPunkIds = [];
                    updatePunkSelectCount();
                    await loadPunkSelectGrid();
                    await loadMyCollection();
                    await loadPunkShowcase();
                } else {
                    try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                    statusEl.textContent = result.error;
                    statusEl.className = 'send-status show error';
                }
            } catch (err) {
                try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {}
                statusEl.textContent = 'Failed: ' + err.message;
                statusEl.className = 'send-status show error';
            } finally {
                submitBtn.disabled = false;
            }
        }

        // ---- Back Button ----
        function updateBackButton() {
            const anyOpen = inscriptionModal.classList.contains('show')
                || document.getElementById('depositModal').classList.contains('show')
                || document.getElementById('sendXntModal').classList.contains('show')
                || document.getElementById('sendPunkModal').classList.contains('show')
                || partyScreen.classList.contains('show')
                || maxMintIntro.classList.contains('show')
                || mintCelebration.classList.contains('show');
            if (anyOpen) {
                tg.BackButton.show();
            } else {
                tg.BackButton.hide();
            }
        }

        // ---- Status ----
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status show ${type}`;
            if (type === 'success') {
                setTimeout(() => { statusMessage.classList.remove('show'); }, 5000);
            }
        }

        // ---- Modal ----
        function closeModal() {
            inscriptionModal.classList.remove('show');
            updateBackButton();
        }

        async function showInscriptionDetails(punkId) {
            inscriptionModal.classList.add('show');
            tg.BackButton.show();
            document.getElementById('modalTitle').textContent = `X1 Punk #${punkId}`;
            document.getElementById('modalPunkImage').src = `https://raw.githubusercontent.com/Execute007/x1punks-images/master/generated/punk_${punkId}.png`;
            document.getElementById('modalAttributes').innerHTML = '<p style="color: #8b949e;">Loading...</p>';
            document.getElementById('modalImageSize').textContent = '';
            document.getElementById('onChainBadge').style.display = 'none';

            try {
                const response = await fetch(`/api/inscription/${punkId}`);
                const data = await safeJson(response);

                if (data.metadata) {
                    const html = data.metadata.attributes.map(attr => `
                        <div class="attribute-box">
                            <div class="attribute-label">${attr.trait_type}</div>
                            <div class="attribute-value">${attr.value}</div>
                        </div>
                    `).join('');
                    document.getElementById('modalAttributes').innerHTML = html;
                    document.getElementById('modalImageSize').textContent = `Image: ${data.imageSize} bytes`;

                    if (data.inscribed && data.onChain) {
                        const badge = document.getElementById('onChainBadge');
                        badge.style.display = 'block';
                        badge.innerHTML = `Fully On-Chain<br><small>Mint: ${data.onChain.mintAddress?.slice(0,8)}...<br>JSON: ${data.onChain.jsonAccount?.slice(0,8)}... (${data.onChain.jsonSize}B)<br>Img: ${data.onChain.imageAccount?.slice(0,8)}... (${data.onChain.imageSize}B)</small>`;
                    }
                }
            } catch (err) {
                document.getElementById('modalAttributes').innerHTML = '<p style="color: #f85149;">Failed to load</p>';
            }
        }

        // ---- Celebration System ----
        async function showPartyScreen(mintedNfts) {
            partyGrid.innerHTML = '';
            partyCounter.textContent = `0 / ${mintedNfts.length}`;
            partyScreen.classList.add('show');
            partyDoneBtn.style.display = 'none';
            tg.BackButton.show();

            for (let i = 0; i < mintedNfts.length; i++) {
                if (!partyScreen.classList.contains('show')) break;

                const nft = mintedNfts[i];
                partyBoomPunk.src = `https://raw.githubusercontent.com/Execute007/x1punks-images/master/generated/punk_${nft.id}.png`;
                partyBoomId.textContent = `X1 Punk #${nft.id}`;
                partyBoomArea.style.display = 'flex';

                const container = document.createElement('div');
                container.className = 'party-punk-container';
                const img = document.createElement('img');
                img.src = `https://raw.githubusercontent.com/Execute007/x1punks-images/master/generated/punk_${nft.id}.png`;
                img.className = 'party-punk new-arrival';
                img.onclick = () => showInscriptionDetails(nft.id);
                const idLabel = document.createElement('div');
                idLabel.className = 'party-punk-id';
                idLabel.textContent = `#${nft.id}`;
                container.appendChild(img);
                container.appendChild(idLabel);
                partyGrid.appendChild(container);

                partyCounter.textContent = `${i + 1} / ${mintedNfts.length}`;
                try { tg.HapticFeedback.impactOccurred('heavy'); } catch(e) {}
                await new Promise(resolve => setTimeout(resolve, 1200));
            }

            partyBoomArea.style.display = 'none';
            partyDoneBtn.style.display = 'block';
        }

        async function showMintCelebration(mintedNfts) {
            skipCelebration = false;
            const isMaxMint = mintedNfts.length >= MAX_PER_MINT;

            if (isMaxMint) {
                partyMintedNfts = mintedNfts;
                maxMintIntro.classList.add('show');
                tg.BackButton.show();
                try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {}
                return new Promise((resolve) => {
                    const check = setInterval(() => {
                        if (!partyScreen.classList.contains('show') && !maxMintIntro.classList.contains('show')) {
                            clearInterval(check);
                            updateBackButton();
                            resolve();
                        }
                    }, 500);
                });
            }

            for (let i = 0; i < mintedNfts.length; i++) {
                if (skipCelebration) break;

                const nft = mintedNfts[i];
                celebrationPunk.src = `https://raw.githubusercontent.com/Execute007/x1punks-images/master/generated/punk_${nft.id}.png`;
                celebrationId.textContent = `X1 Punk #${nft.id}`;
                celebrationText.textContent = 'BOOM!';
                celebrationCounter.textContent = `${i + 1} of ${mintedNfts.length}`;

                mintCelebration.className = 'mint-celebration';
                const rarity = nft.inscription?.attributes?.find(a => a.trait_type === 'Rarity')?.value;
                if (rarity === 'Legendary') mintCelebration.classList.add('celebration-legendary');
                else if (rarity === 'Epic') mintCelebration.classList.add('celebration-epic');
                else if (rarity === 'Rare') mintCelebration.classList.add('celebration-rare');
                else mintCelebration.classList.add('celebration-common');

                mintCelebration.classList.add('show');
                tg.BackButton.show();
                try { tg.HapticFeedback.impactOccurred('medium'); } catch(e) {}

                await new Promise(resolve => setTimeout(resolve, 1500));

                if (i < mintedNfts.length - 1 && !skipCelebration) {
                    mintCelebration.classList.remove('show');
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }

            mintCelebration.classList.remove('show');
            mintCelebration.className = 'mint-celebration';
            updateBackButton();
        }
    </script>
</body>
</html>
